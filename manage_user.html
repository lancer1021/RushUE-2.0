<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Rush UE — Admin: Manage Users</title>

  <!-- UI: Bootstrap + Font Awesome + Google Font -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"/>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;600&display=swap" rel="stylesheet"/>

  <!-- Firebase (compat builds to match your other pages) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

  <style>
    body{
      font-family:'Poppins',sans-serif;
      background:linear-gradient(to bottom,#fbd1dc,#fff);
      min-height:100vh;display:flex;flex-direction:column;overflow-x:hidden;
    }
    .animated-bg,.animated-bg2{
      position:fixed;z-index:0;border-radius:50%;opacity:.3;filter:blur(80px);
    }
    .animated-bg{top:-100px;left:-100px;width:300px;height:300px;
      background:radial-gradient(circle,#ffdde1,#fbd1dc);
      animation:float 10s ease-in-out infinite;}
    .animated-bg2{bottom:-120px;right:-120px;width:250px;height:250px;
      background:radial-gradient(circle,#ffc2d1,#f8b5bd);
      animation:float2 12s ease-in-out infinite;}
    @keyframes float{0%,100%{transform:translateY(0) translateX(0)}50%{transform:translateY(20px) translateX(10px)}}
    @keyframes float2{0%,100%{transform:translateY(0) translateX(0)}50%{transform:translateY(-15px) translateX(-20px)}}

    .header-container{
      display:flex;align-items:center;padding:20px;background:#fff;
      box-shadow:0 2px 8px rgba(0,0,0,.05);z-index:2;position:relative;
    }
    .header-container img{
      width:70px;height:70px;object-fit:cover;border-radius:50%;margin-right:15px;
      box-shadow:0 4px 12px rgba(220,53,69,.3);
    }
    .header-title{font-weight:600;font-size:1.5rem;margin:0;padding-left:20px;margin-top:5px;color:#dc3545}
    .table th,.table td{vertical-align:middle}
    footer{background:#dc3545;color:#fff;font-size:.9rem;z-index:2;position:relative}
    footer a{color:#fff;text-decoration:underline}
    .badge-role{background:#ffe9ec;color:#dc3545;border:1px solid #ffc2cc}
  </style>
</head>
<body>

<!-- Background decor -->
<div class="animated-bg"></div>
<div class="animated-bg2"></div>

<!-- Header -->
<div class="header-container">
  <a href="admininside.html"><img src="images/rushuelogo.jpg" alt="UE Logo"/></a>
  <div>
    <h2 class="header-title mb-0">User Dashboard</h2>
    <div class="small text-muted" id="whoami">Checking session…</div>
  </div>
  <div class="ms-auto">
    <button id="btnSignOut" class="btn btn-outline-danger btn-sm"><i class="fa-solid fa-right-from-bracket"></i> Sign out</button>
  </div>
</div>

<!-- Main -->
<div class="container my-5">
  <div class="d-flex align-items-center mb-3">
    <h4 class="text-danger mb-0">Registered Users</h4>
    <span id="adminGuard" class="ms-3 badge badge-role d-none">Admin mode</span>
  </div>

  <div class="table-responsive">
    <table class="table table-bordered table-hover text-center bg-white">
      <thead class="table-danger">
        <tr>
          <th style="width:18%">First Name</th>
          <th style="width:18%">Last Name</th>
          <th style="width:28%">Email</th>
          <th style="width:18%">Role</th>
          <th style="width:18%">Actions</th>
        </tr>
      </thead>
      <tbody id="userTableBody">
        <!-- rows injected here -->
      </tbody>
    </table>
  </div>
</div>

<!-- Edit Modal -->
<div class="modal fade" id="editUserModal" tabindex="-1" aria-labelledby="editUserModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="editUserForm">
        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title" id="editUserModalLabel">Edit User</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <!-- we edit only the profile stored in Realtime DB (not Auth password) -->
          <input type="hidden" id="editUserId"/>
          <div class="mb-3">
            <label for="editFirstName" class="form-label">First Name</label>
            <input type="text" class="form-control" id="editFirstName" required/>
          </div>
          <div class="mb-3">
            <label for="editLastName" class="form-label">Last Name</label>
            <input type="text" class="form-control" id="editLastName" required/>
          </div>
          <div class="mb-3">
            <label for="editEmail" class="form-label">Email (profile)</label>
            <input type="email" class="form-control" id="editEmail" required/>
            <div class="form-text">
              This updates the email stored in <code>Realtime Database</code>.  
              Changing the actual <strong>Auth</strong> email/password requires Firebase Auth APIs.
            </div>
          </div>
          <div class="mb-2">
            <label class="form-label">Role</label>
            <select id="editRole" class="form-select">
              <option value="student">student</option>
              <option value="admin">admin</option>
            </select>
            <div class="form-text">
              (Optional) You can mark a profile's role field here; access control still depends on your Rules.
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-danger">Save Changes</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Footer -->
<footer class="text-center py-4 mt-auto">
  <div class="container">
    <p class="mb-0">&copy; 2025 University of the East | <a href="#">Rush UE</a></p>
  </div>
</footer>

<!-- App -->
<script>
  // --- Firebase config ---
  const firebaseConfig = {
    apiKey: "AIzaSyAO-rovSC2xK4ZUV9pD3ixKViQl9x4xzNk",
    authDomain: "rushue-234bc.firebaseapp.com",
    databaseURL: "https://rushue-234bc-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "rushue-234bc",
    storageBucket: "rushue-234bc.appspot.com",
    messagingSenderId: "574730836644",
    appId: "1:574730836644:web:ff7c9e9eae7fc498e4a431"
  };
  firebase.initializeApp(firebaseConfig);

  const auth = firebase.auth();
  const db   = firebase.database();

  const whoamiEl     = document.getElementById('whoami');
  const adminBadgeEl = document.getElementById('adminGuard');
  const tableBodyEl  = document.getElementById('userTableBody');

  const ADMIN_EMAIL = 'lanceconcepcion1021@gmail.com';
  let CURRENT_USER = null;
  let IS_ADMIN = false;

  // session + admin gate by email
  auth.onAuthStateChanged(async (u) => {
    if (!u) {
      whoamiEl.textContent = 'Not signed in — redirecting to login…';
      setTimeout(() => (window.location.href = 'login.html'), 900);
      return;
    }
    CURRENT_USER = u;
    const email = (u.email || '').toLowerCase();
    IS_ADMIN = (email === ADMIN_EMAIL);

    whoamiEl.textContent = `Signed in as ${u.email || '(no email)'} — uid ${u.uid.slice(0,6)}…`;
    if (!IS_ADMIN) {
      whoamiEl.textContent += ' — not admin';
      alert('You are signed in, but only Lance can access the admin dashboard. Redirecting.');
      setTimeout(() => (window.location.href = 'student.html'), 1000);
      return;
    }

    adminBadgeEl.classList.remove('d-none');
    fetchUsers();
  });

  // sign out
  document.getElementById('btnSignOut').addEventListener('click', async () => {
    try { await auth.signOut(); } catch(e) { console.error(e); }
    window.location.href = 'login.html';
  });

  // list users (skip flat mirror keys like users.email)
  function fetchUsers(){
    db.ref('users').on('value', (snapshot) => {
      tableBodyEl.innerHTML = '';
      snapshot.forEach((child) => {
        const userId = child.key;
        const user   = child.val();
        if (typeof user !== 'object' || !user.uid) return; // skip non-profile keys

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${escapeHtml(user.firstName || '')}</td>
          <td>${escapeHtml(user.lastName  || '')}</td>
          <td>${escapeHtml(user.email     || '')}</td>
          <td><span class="badge badge-role">${escapeHtml(user.role || 'student')}</span></td>
          <td>
            <button class="btn btn-sm btn_WARNING me-2 btn-warning" onclick="editUser('${userId}')">
              <i class="fas fa-edit"></i> Edit
            </button>
            <button class="btn btn-sm btn-danger" onclick="deleteUser('${userId}')">
              <i class="fas fa-trash-alt"></i> Delete
            </button>
          </td>`;
        tableBodyEl.appendChild(tr);
      });
    }, (err) => {
      console.error(err);
      alert('Read failed: ' + err.message);
    });
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, (c) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }

  // open modal
  window.editUser = async function(userId){
    if (!IS_ADMIN) return alert('Not allowed.');
    try {
      const snap = await db.ref('users/' + userId).get();
      const user = snap.val();
      if (!user) return;

      document.getElementById('editUserId').value    = userId;
      document.getElementById('editFirstName').value = user.firstName || '';
      document.getElementById('editLastName').value  = user.lastName  || '';
      document.getElementById('editEmail').value     = user.email     || '';
      document.getElementById('editRole').value      = user.role || 'student';

      const modal = new bootstrap.Modal(document.getElementById('editUserModal'));
      modal.show();
    } catch (e) {
      console.error(e);
      alert('Failed to open user: ' + e.message);
    }
  };

  // save changes (profile only; not Auth email/password)
  document.getElementById('editUserForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!IS_ADMIN) return alert('Not allowed.');

    const userId    = document.getElementById('editUserId').value;
    const firstName = document.getElementById('editFirstName').value.trim();
    const lastName  = document.getElementById('editLastName').value.trim();
    const email     = document.getElementById('editEmail').value.trim();
    const role      = document.getElementById('editRole').value;

    try {
      await db.ref('users/' + userId).update({ firstName, lastName, email, role });
      bootstrap.Modal.getInstance(document.getElementById('editUserModal')).hide();
      alert('User updated successfully.');
    } catch (err) {
      console.error(err);
      alert('Error updating user: ' + err.message);
    }
  });

  // delete
  window.deleteUser = async function(userId){
    if (!IS_ADMIN) return alert('Not allowed.');
    if (!confirm('Delete this user profile from the database? This cannot be undone.')) return;
    try {
      await db.ref('users/' + userId).remove();
      alert('User deleted successfully.');
    } catch (err) {
      console.error(err);
      alert('Error deleting user: ' + err.message);
    }
  };
</script>


<!-- Bootstrap JS bundle -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
